name: CD - Deploy and Release

on:
  push:
    branches:
      - main
      - feature/deploy-workflow # For testing purposes
  workflow_dispatch:

jobs:
  # IF WE WANT TO RUN CI AS PART OF THIS WORKFLOW THEN...
  # Uncomment the block below to add an explicit CI job that runs before deployment.
  # This calls the CI workflow to ensure that all tests and checks pass before we attempt to deploy.
  # However this is redundant, since we already run CI on every pr to main.
  # 
  # run_ci:
  #  uses: ./.github/workflows/ci.yml

  docker:
    # Uncomment the line below to make this job depend on the CI job, ensuring it only runs if CI passes.
    # needs: run_ci
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Read version
        id: version
        run: echo "VERSION=$(cat VERSION)" >> $GITHUB_OUTPUT

      # Log in to Docker Hub using credentials stored in GitHub secrets.
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Builds the Docker image using Dockerfile (which handles restore, build and publish internally)
      # and pushes it to Docker Hub tagged with both the version number and 'latest', e.g.:
      #   rasmusachr/minitwit:1.0.0
      #   rasmusachr/minitwit:latest
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          platforms: linux/arm64
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/minitwit:${{ steps.version.outputs.VERSION }}
            ${{ secrets.DOCKERHUB_USERNAME }}/minitwit:latest

  deploy:
    needs: docker
    runs-on: ubuntu-latest
    environment: production  # Enables GitHub environment protection rules and approval gates
    steps:
      - uses: actions/checkout@v4
      
      # Copies the docker-compose file from the repo to the Hetzner server before deploying.
      # This ensures the server always uses the latest version of the compose file.
      - name: Copy docker-compose file to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: prod-compose/docker-compose.devops-serv1.yml
          target: ~/chirp/
      
      # SSHes into Hetzner server, pulls the latest image from Docker Hub (public repo, no login needed),
      # and restarts the stack using prod docker-compose file.
      # This requires the following GitHub secrets:
      #   SSH_HOST:        Hetzner server IP or hostname
      #   SSH_USER:        SSH user on the server
      #   SSH_PRIVATE_KEY: private key that matches a public key authorized on the server
      - name: Deploy to Hetzner via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin
            docker pull rasmusachr/minitwit:latest
            docker compose -f ~/chirp/prod-compose/docker-compose.devops-serv1.yml up -d
            docker logout

  # This job creates a GitHub Release. It generates a tag and changelog based on merged PRs since the last release.
  release:
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Is needed to generate changelog from full git history

      - name: Read version
        id: version
        run: echo "VERSION=$(cat VERSION)" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.VERSION }}
          name: Release v${{ steps.version.outputs.VERSION }}
          generate_release_notes: true           # Auto-generates changelog from merged PRs
          token: ${{ secrets.GITHUB_TOKEN }}     # GITHUB_TOKEN is built-in, no setup needed